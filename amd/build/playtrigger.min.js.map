{"version":3,"file":"playtrigger.min.js","sources":["../src/playtrigger.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Scripts for mod_kalmediares\n *\n * @copyright (C) 2016-2023 Yamaguchi University (gh-cc@mlex.cc.yamaguchi-u.ac.jp)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_kalmediares/playtrigger\n */\n\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initial function.\n         * @access public\n         * @param {string} serviceURL - url of event record page.\n         * @param {string} cmid - id of content module.\n         */\n        init: function(serviceURL, cmid) {\n\n            var videoTags;\n            var iframeTags;\n            var trigger = false;\n            var listener = false;\n            var checkAction = null;\n            var scchange = \"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange\";\n\n            /**\n             * This function retrieve os type.\n             * @return {string} - os type.\n             */\n            function getOperatingSystem() {\n                var os;\n                var ua = navigator.userAgent;\n\n                if (ua.match(/iPhone|iPad|iPod|IPHONE|IPAD|IPOD|iphone|ipad|ipod/)) {\n                    os = \"iOS\";\n                } else if (ua.match(/Android|android|ANDROID/)) {\n                    os = \"Android\";\n                } else if (ua.match(/Linux|linux|LINUX|ubuntu|Ubuntu|UBUNTU/)) {\n                    os = \"Linux\";\n                } else if (ua.match(/Win(dows)|WIN(DOWS)/)) {\n                    os = \"Windows\";\n                } else if (ua.match(/Mac|PPC/)) {\n                    os = \"Mac OS\";\n                } else if (ua.match(/CrOS/)) {\n                    os = \"Chrome OS\";\n                } else if (ua.match(/mobile|Mobile|MOBILE/)) {\n                    os = \"Mobile\";\n                } else {\n                    os = \"Other\";\n                }\n\n                return os;\n            }\n\n            /**\n             * This function trigger event.\n             * @return {bool} - true if event transmission was succeed. Otherwise false.\n             */\n            function triggerEvent() {\n                var fd = new FormData();\n                var flag;\n\n                fd.append('id', cmid);\n\n                // Create tnrasmission data.\n                var postData = {\n                    type: 'POST',\n                    data: fd,\n                    cache: false,\n                    contentType: false,\n                    scriptCharset: 'utf-8',\n                    processData: false,\n                    async: true,\n                    dataType: 'xml'\n                };\n\n                serviceURL = serviceURL + '?id=' + cmid;\n\n                // Transmit data.\n                $.ajax(\n                   serviceURL, postData\n                )\n                .done(function(xmlData) {\n                    // Response is not XML.\n                    if (xmlData === null) {\n                        flag = false;\n                    }\n\n                    flag = true;\n                })\n                .fail(function(xmlData) {\n                    window.console.dir(xmlData);\n                    flag = false;\n                });\n\n                return flag;\n            }\n\n            /**\n             * This function arise play event.\n             */\n            function arisePlay() {\n                videoTags.off(\"play\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise playing event.\n             */\n            function arisePlaying() {\n                videoTags.off(\"playing\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise timeupdate event.\n             */\n            function ariseTimeupdate() {\n                videoTags.off(\"timeupdate\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise seeked event.\n             */\n            function ariseSeeked() {\n                videoTags.off(\"seeked\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise pause event.\n             */\n            function arisePause() {\n                videoTags.off(\"pause\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise ended event.\n             */\n            function ariseEnded() {\n                videoTags.off(\"ended\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise ratechange event.\n             */\n            function ariseRatechange() {\n                videoTags.off(\"ratechange\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function adds callback functions to video element.\n             * @param {object} element - element object for video tag.\n             */\n            function setCallback(element) {\n                var mobile = false;\n                var os = getOperatingSystem();\n\n                if (os == 'iOS' || os == 'Android' || os == 'Chrome OS' || os == 'Mobile') {\n                    mobile = true;\n                }\n\n                if (element !== null && element.length >= 1) {\n                    element.on(\"play\", function() {\n                        arisePlay();\n                    });\n                    element.on(\"playing\", function() {\n                        arisePlaying();\n                    });\n\n                    if (mobile === true) {\n                        element.on(\"timeupdate\", function() {\n                            ariseTimeupdate();\n                        });\n                        element.on(\"seeked\", function() {\n                            ariseSeeked();\n                        });\n                        element.on(\"pause\", function() {\n                            arisePause();\n                        });\n                        element.on(\"ended\", function() {\n                            ariseEnded();\n                        });\n                        element.on(\"ratechange\", function() {\n                            ariseRatechange();\n                        });\n                    }\n\n                    listener = true;\n                }\n            }\n\n            /**\n             * This function retrieve video element.\n             */\n            function checkElement() {\n                if (listener === false && trigger === false) {\n                    videoTags = $(\"video\");\n                    if (videoTags !== null && videoTags.length >= 1) {\n                        setCallback(videoTags);\n                    } else {\n                        iframeTags = $(\"iframe\");\n                        if (iframeTags !== null && iframeTags.length >= 1) {\n                            videoTags = iframeTags.eq(0).contents().find(\"video\");\n                            if (videoTags !== null && videoTags.length >= 1) {\n                                setCallback(videoTags);\n                            }\n                        }\n                    }\n                }\n\n                if (listener === true && checkAction !== null) {\n                    clearInterval(checkAction);\n                }\n            }\n\n            if (serviceURL !== null && serviceURL !== \"\") {\n                $(document).ready(function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n\n                $(\"iframe\").on(\"load\", function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n\n                $(window).on(\"load\", function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n\n                $(window).on(scchange, function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n            }\n        }\n    };\n});\n"],"names":["define","$","init","serviceURL","cmid","videoTags","iframeTags","trigger","listener","checkAction","triggerEvent","flag","fd","FormData","append","postData","type","data","cache","contentType","scriptCharset","processData","async","dataType","ajax","done","xmlData","fail","window","console","dir","setCallback","element","ua","mobile","os","navigator","userAgent","match","length","on","off","checkElement","eq","contents","find","clearInterval","document","ready","setInterval"],"mappings":"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"}