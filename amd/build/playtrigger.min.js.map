{"version":3,"sources":["../src/playtrigger.js"],"names":["define","$","init","serviceURL","cmid","videoTags","iframeTags","trigger","listener","checkAction","getOperatingSystem","os","ua","navigator","userAgent","match","triggerEvent","fd","FormData","flag","append","ajax","type","data","cache","contentType","scriptCharset","processData","async","dataType","done","xmlData","fail","window","console","dir","arisePlay","off","arisePlaying","ariseTimeupdate","ariseSeeked","arisePause","ariseEnded","ariseRatechange","setCallback","element","mobile","length","on","checkElement","eq","contents","find","clearInterval","document","ready","setInterval"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Scripts for mod_kalmediares\n *\n * @package    mod_kalmediares\n * @copyright  (C) 2016-2021 Yamaguchi University (gh-cc@mlex.cc.yamaguchi-u.ac.jp)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_kalmediares/playtrigger\n */\n\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initial function.\n         * @access public\n         * @param {string} serviceURL - url of event record page.\n         * @param {string} cmid - id of content module.\n         */\n        init: function(serviceURL, cmid) {\n\n            var videoTags;\n            var iframeTags;\n            var trigger = false;\n            var listener = false;\n            var checkAction = null;\n            var scchange = \"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange\";\n\n            /**\n             * This function retrieve os type.\n             * @return {string} - os type.\n             */\n            function getOperatingSystem() {\n                var os;\n                var ua = navigator.userAgent;\n\n                if (ua.match(/iPhone|iPad|iPod|IPHONE|IPAD|IPOD|iphone|ipad|ipod/)) {\n                    os = \"iOS\";\n                } else if (ua.match(/Android|android|ANDROID/)) {\n                    os = \"Android\";\n                } else if (ua.match(/Linux|linux|LINUX|ubuntu|Ubuntu|UBUNTU/)) {\n                    os = \"Linux\";\n                } else if (ua.match(/Win(dows)|WIN(DOWS)/)) {\n                    os = \"Windows\";\n                } else if (ua.match(/Mac|PPC/)) {\n                    os = \"Mac OS\";\n                } else if (ua.match(/CrOS/)) {\n                    os = \"Chrome OS\";\n                } else if (ua.match(/mobile|Mobile|MOBILE/)) {\n                    os = \"Mobile\";\n                } else {\n                    os = \"Other\";\n                }\n\n                return os;\n            }\n\n            /**\n             * This function trigger event.\n             * @return {bool} - true if event transmission was succeed. Otherwise false.\n             */\n            function triggerEvent() {\n                var fd = new FormData();\n                var flag;\n\n                fd.append('id', cmid);\n\n                // Create tnrasmission data.\n                var postData = {\n                    type: 'POST',\n                    data: fd,\n                    cache: false,\n                    contentType: false,\n                    scriptCharset: 'utf-8',\n                    processData: false,\n                    async: true,\n                    dataType: 'xml'\n                };\n\n                serviceURL = serviceURL + '?id=' + cmid;\n\n                // Transmit data.\n                $.ajax(\n                   serviceURL, postData\n                )\n                .done(function(xmlData) {\n                    // Response is not XML.\n                    if (xmlData === null) {\n                        flag = false;\n                    }\n\n                    flag = true;\n                })\n                .fail(function(xmlData) {\n                    window.console.dir(xmlData);\n                    flag = false;\n                });\n\n                return flag;\n            }\n\n            /**\n             * This function arise play event.\n             */\n            function arisePlay() {\n                videoTags.off(\"play\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise playing event.\n             */\n            function arisePlaying() {\n                videoTags.off(\"playing\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise timeupdate event.\n             */\n            function ariseTimeupdate() {\n                videoTags.off(\"timeupdate\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise seeked event.\n             */\n            function ariseSeeked() {\n                videoTags.off(\"seeked\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise pause event.\n             */\n            function arisePause() {\n                videoTags.off(\"pause\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise ended event.\n             */\n            function ariseEnded() {\n                videoTags.off(\"ended\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function arise ratechange event.\n             */\n            function ariseRatechange() {\n                videoTags.off(\"ratechange\", \"**\");\n                if (trigger === false) {\n                    trigger = true;\n                    triggerEvent();\n                }\n            }\n\n            /**\n             * This function adds callback functions to video element.\n             * @param {object} element - element object for video tag.\n             */\n            function setCallback(element) {\n                var mobile = false;\n                var os = getOperatingSystem();\n\n                if (os == 'iOS' || os == 'Android' || os == 'Chrome OS' || os == 'Mobile') {\n                    mobile = true;\n                }\n\n                if (element !== null && element.length >= 1) {\n                    element.on(\"play\", function() {\n                        arisePlay();\n                    });\n                    element.on(\"playing\", function() {\n                        arisePlaying();\n                    });\n\n                    if (mobile === true) {\n                        element.on(\"timeupdate\", function() {\n                            ariseTimeupdate();\n                        });\n                        element.on(\"seeked\", function() {\n                            ariseSeeked();\n                        });\n                        element.on(\"pause\", function() {\n                            arisePause();\n                        });\n                        element.on(\"ended\", function() {\n                            ariseEnded();\n                        });\n                        element.on(\"ratechange\", function() {\n                            ariseRatechange();\n                        });\n                    }\n\n                    listener = true;\n                }\n            }\n\n            function checkElement() {\n                if (listener === false && trigger === false) {\n                    videoTags = $(\"video\");\n                    if (videoTags !== null && videoTags.length >= 1) {\n                        setCallback(videoTags);\n                    } else {\n                        iframeTags = $(\"iframe\");\n                        if (iframeTags !== null && iframeTags.length >= 1) {\n                            videoTags = iframeTags.eq(0).contents().find(\"video\");\n                            if (videoTags !== null && videoTags.length >= 1) {\n                                setCallback(videoTags);\n                            }\n                        }\n                    }\n                }\n\n                if (listener === true && checkAction !== null) {\n                    clearInterval(checkAction);\n                }\n            }\n\n            if (serviceURL !== null && serviceURL !== \"\") {\n                $(document).ready(function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n\n                $(\"iframe\").on(\"load\", function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n\n                $(window).on(\"load\", function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n\n                $(window).on(scchange, function() {\n                    if (trigger === false && listener === false) {\n                        checkElement();\n                    }\n\n                    if (checkAction === null) {\n                        checkAction = setInterval(checkElement, 1000);\n                    }\n                });\n            }\n        }\n    };\n});\n"],"file":"playtrigger.min.js"}